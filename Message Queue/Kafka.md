카프카:Apache Kafka
==================

## 1. 카프카 특징
#### 1. 다중 프로듀서 & 컨슈머
- 카프카는 하나의 토픽에 여러 프로듀서가 동시에 메시지를 선종할 수 있다. 또한, 토픽의 메시지를 여러 컨슈머들이 동시에 읽어 갈 수 있다.
- 하나의 프로듀서가 여러 토픽에 메시지를 전송할 수도 있으며, 하나의 컨슈머가 여러 토픽에서 메시지를 읽어 갈 수도 있다.  


#### 2. 파일 시스템 저장
- 카프카는 프로듀서가 생성한 메시지를 브로커가 위치한 서버의 파일 시스템에 저장한다. 따라서 컨슈머는 프로듀서가 생성한 메시지를 바로바로 소비하지 않아도 된다.
- 네트워크 문제나 컨슈머쪽에 장애 발생시 데이터 유실을 방지해주며, 배치 처리를 가능하게 해준다.


#### 3. 확장성 
- 데이터 파이프라인을 구축한 초창기에는 소수의 브로커로 운영하다가 트래픽이 높아지면 브로커를 추가해서 클러스터를 확장할 수 있다.
- 프로듀서, 컨슈머 또한 운영 중에 증가시킬 수 있으며, 토픽, 파티션도 증가가 가능하다.
#### 4. 고성능
- 카프카는 대용량 실시간 로그 처리에 특화되어 있다. 높은 처리량(Throughput)을 위해 설계되었다.
- 예를들어 복수의 큐에 메시지를 원자적으로 전달 할 수 있는 트랜잭션 기능을 배제시켜 성능을 향상 시켰다.

## 2. 카프카 살펴보기
#### 1. 구조
크게 Producer, Broker, Consumer로 나눌 수 있다.
- Producer : 메시지를 보내는 서버. 프로듀서에서 메시지를 전송하면 여러 파티션을 사용하게 되는데 이때는 순서를 보장할 수 없다.
순서가 필요한 데이터는 key를 할당하여 특정 파티션에 전송할 수 있다.(다른 파티션으로 각각 보내진다면 컨슈머에서 소비하는 순서를 보장할 수 없기 때문에 같은 파티션을 사용한다)
- Kafka : 카프카 애플리케이션이 설치된 서버(브로커). 주키퍼라는 분산 코디네이터를 사용해서 브로커들을 클러스터링하고, 관리한다.
- Consumer : 메시지 수신하는 서버.카프카의 컨슈머는 컨슈머 그룹을 형성하는데, 토픽은 컨슈머 그룹 단위로 구독되어진다. 토픽의 파티션은 컨슈머 그룹 당 하나의 컨슈머의 소비만 가능하다.
이러한 연결을 소유권(Ownership)이라 한다. 즉, 같은 컨슈머내에서 동시에 동일한 파티션에서 메시지를 읽어갈 수 없다.(offset 값을 할당하여 각 컨슈머 그룹이 파티션에서 어디까지 읽었는지 기록한다)

producer, consumer 그리고 Broker(MQ 시스템 - RabbitMQ, Kafka)는 같은 host내에서 상주할 필요는 없고, 각각의 애플리케이션은 producer, consumer 둘 다 될수 있다.

![mq_broker](/image/mq/카프카%20구조.png)

#### 2. 용어 설명
1. 토픽: 카프카에 전달되는 메시지 스트림의 추상화된 개념. 프로듀서는 메시지를 특정 토픽에 발행, 컨슈머는 메시지를 특정 토픽에서 구독한다.
2. 파티션: 카프카는 토픽을 파티션으로 세분화시켜 관리한다.
3. 세그먼트 파일: 파티션에 저장된 메시지를 파일 시스템에 저장하는데, 이 때 만들어지는 파일이 세그먼트 파일이다. 기본적으로 파일이 1GB이 넘거나 일정 기간이 지나면 파일을 다시 만든다.


